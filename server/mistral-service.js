import axios from 'axios';

// Mistral AI Configuration
const MISTRAL_API_KEY = 'bnXRKcksJSDzVBl6lWYM6LVeL7XKFZ0e';
const MISTRAL_API_URL = 'https://api.mistral.ai/v1/chat/completions';

console.log('ðŸ”‘ Mistral API Key configured:', MISTRAL_API_KEY ? 'Yes (' + MISTRAL_API_KEY.substring(0, 8) + '...)' : 'No');
console.log('ðŸ¤– Using Mistral Model: mistral-medium-latest');

async function generateCodeWithMistral(prompt) {
  // Input validation
  if (!prompt || !prompt.trim()) {
    throw new Error('Prompt is required and cannot be empty.');
  }

  // Validate API key
  if (!MISTRAL_API_KEY || MISTRAL_API_KEY.length < 10) {
    throw new Error('Mistral API key is not properly configured.');
  }

  try {
    console.log('ðŸ¤– Calling Mistral Medium with prompt:', prompt.substring(0, 100) + '...');
    
    const requestBody = {
      model: 'mistral-medium-latest',
      messages: [
        {
          role: 'system',
          content: `You are an expert full-stack developer. Generate complete, production-ready code for web applications. Always return a JSON object with a "files" array containing objects with "name", "language", and "content" properties. Include HTML, CSS, and JavaScript files.`
        },
        {
          role: 'user',
          content: `Create a complete web application: ${prompt}. Provide only valid JSON response with files array.`
        }
      ],
      temperature: 0.7,
      max_tokens: 2000
    };

    console.log('ðŸ“¤ Sending request to Mistral API (Medium model)...');
    const response = await axios.post(MISTRAL_API_URL, requestBody, {
      headers: {
        'Authorization': `Bearer ${MISTRAL_API_KEY}`,
        'Content-Type': 'application/json',
      },
      timeout: 15000
    });

    console.log('âœ… Received response from Mistral Medium');
    
    if (!response.data || !response.data.choices || !response.data.choices[0]) {
      throw new Error('Invalid response structure from Mistral API');
    }

    const content = response.data.choices[0].message.content;
    console.log('ðŸ“¥ Raw response length:', content.length);

    // Try to parse JSON response
    try {
      const parsed = JSON.parse(content);
      if (parsed.files && Array.isArray(parsed.files)) {
        console.log(`âœ… Successfully parsed ${parsed.files.length} files from Mistral Medium`);
        return parsed.files;
      } else {
        throw new Error('Invalid files structure in response');
      }
    } catch (parseError) {
      console.log('âš ï¸ JSON parse failed, using fallback files');
      return createFallbackFiles(prompt);
    }
  } catch (error) {
    console.error('âŒ Mistral Medium API Error:', error.message);
    
    // Use fallback for any errors
    console.log('ðŸ”„ Using fallback due to API error');
    return createFallbackFiles(prompt);
  }
}

function createFallbackFiles(prompt) {
  console.log('ðŸ› ï¸ Creating fallback files for:', prompt);
  const timestamp = new Date().toISOString();
  return [
    {
      name: 'index.html',
      language: 'html',
      content: `<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>${prompt}</title>
    <link rel="stylesheet" href="style.css">
</head>
<body>
    <div class="container">
        <h1>${prompt}</h1>
        <p>Generated by Multiverse AI with Mistral Medium</p>
        <p>Generated at: ${timestamp}</p>
    </div>
    <script src="script.js"></script>
</body>
</html>`
    },
    {
      name: 'style.css',
      language: 'css',
      content: `/* Styles for ${prompt} */
body {
    font-family: Arial, sans-serif;
    margin: 0;
    padding: 0;
    background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
    color: white;
    min-height: 100vh;
}

.container {
    max-width: 800px;
    margin: 0 auto;
    padding: 40px 20px;
    text-align: center;
}

h1 {
    font-size: 2.5em;
    margin-bottom: 20px;
    text-shadow: 2px 2px 4px rgba(0,0,0,0.3);
}

p {
    font-size: 1.2em;
    opacity: 0.9;
}`
    },
    {
      name: 'script.js',
      language: 'javascript',
      content: `// JavaScript for ${prompt}
console.log('App loaded successfully!');

// Add any interactive functionality here
document.addEventListener('DOMContentLoaded', function() {
    console.log('DOM fully loaded and parsed');
});`
    }
  ];
}

export { generateCodeWithMistral };
