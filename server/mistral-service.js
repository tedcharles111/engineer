const axios = require('axios');

const MISTRAL_API_KEY = '8sco68RTiZlzi3DbcmOMM8uYKiJwbOvu';
const MISTRAL_API_URL = 'https://api.mistral.ai/v1/chat/completions';

async function generateCodeWithMistral(prompt) {
  try {
    console.log('ü§ñ Calling Mistral AI with prompt:', prompt);
    
    const response = await axios.post(MISTRAL_API_URL, {
      model: 'mistral-large-latest',
      messages: [
        {
          role: 'system',
          content: `You are an expert full-stack developer. Generate complete, production-ready code for web applications.
          Always return a JSON object with multiple files including:
          - Frontend (HTML, CSS, JavaScript)
          - Backend (Node.js/Express if needed)
          - Package.json if Node.js project
          - README.md with setup instructions
          - Any other necessary files
          
          Format your response as JSON: {
            "files": [
              {"name": "filename", "language": "language", "content": "file content"},
              ...
            ]
          }`
        },
        {
          role: 'user',
          content: `Create a complete web application: ${prompt}`
        }
      ],
      temperature: 0.7,
      max_tokens: 4000
    }, {
      headers: {
        'Authorization': `Bearer ${MISTRAL_API_KEY}`,
        'Content-Type': 'application/json'
      }
    });

    const content = response.data.choices[0].message.content;
    
    // Parse the JSON response
    try {
      const parsed = JSON.parse(content);
      return parsed.files || [];
    } catch (error) {
      // If not JSON, create a simple HTML file
      console.log('Mistral returned non-JSON response, creating fallback files');
      return [
        {
          name: 'index.html',
          language: 'html',
          content: `<!DOCTYPE html>
<html>
<head>
    <title>${prompt}</title>
    <style>
        body { font-family: Arial, sans-serif; margin: 40px; background: #1a1a1a; color: white; }
        .container { max-width: 800px; margin: 0 auto; }
    </style>
</head>
<body>
    <div class="container">
        <h1>${prompt}</h1>
        <p>Generated by Multiverse AI with Mistral Large</p>
        <div id="app"></div>
    </div>
    <script>
        // Application code will go here
        console.log("App loaded successfully");
    </script>
</body>
</html>`
        }
      ];
    }
  } catch (error) {
    console.error('‚ùå Mistral AI Error:', error.response?.data || error.message);
    throw new Error(`Mistral AI generation failed: ${error.message}`);
  }
}

module.exports = { generateCodeWithMistral };
